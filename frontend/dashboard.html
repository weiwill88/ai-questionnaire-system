<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåº”ç”¨éœ€æ±‚è°ƒç ” - ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.6.2/dist/countUp.umd.js"></script>
    <style>
        /* ä¸“ä¸šBIé£æ ¼ - æ¸å˜é…è‰² */
        .gradient-blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-green {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .gradient-purple {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .gradient-orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        /* Tabé€‰é¡¹å¡æ ·å¼ */
        .tab-btn {
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1rem;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            background: transparent;
            cursor: pointer;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }
        .tab-btn:hover:not(.active) {
            color: #111827;
            background: #f9fafb;
        }
        
        /* æ•°å­—åŠ¨ç”» */
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stat-number {
            animation: countUp 0.6s ease-out;
        }
        
        /* å¡ç‰‡é˜´å½± */
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* LoadingåŠ¨ç”» */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- ===== é…ç½®åŒºåŸŸ ===== -->
<script>
const CONFIG = {
    SUPABASE_URL: 'https://rnidqivrrsbcemywpryk.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJuaWRxaXZycnNiY2VteXdwcnlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTcwNzUsImV4cCI6MjA3ODY3MzA3NX0.TN8eCSMXAQM6mQcrzIw7ZlkE1d2Z7UZm_I0lYsI3Tek',
    SESSION_ID: 'SJTU_SAIF_20251114',
    API_BASE_URL: 'http://106.54.62.229:8000'
};

// å…¨å±€å˜é‡
let supabase;
let statsData = null;
let analysisData = null;
let charts = {};
</script>

<div class="min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">AIåº”ç”¨éœ€æ±‚è°ƒç ” - å®æ—¶ç®¡ç†åå°</h1>
                    <p class="text-sm text-gray-500 mt-1">ä¸Šæµ·äº¤é€šå¤§å­¦é«˜çº§é‡‘èå­¦é™¢ MBA è¯¾ç¨‹</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshData()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        ğŸ”„ åˆ·æ–°
                    </button>
                    <button onclick="exportData()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        ğŸ“¥ å¯¼å‡ºCSV
                    </button>
                    <button onclick="closeSession()" class="px-4 py-2 bg-red-50 border border-red-200 text-red-600 rounded-lg hover:bg-red-100 transition">
                        â›” å…³é—­åœºæ¬¡
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-6">
        
        <!-- Tabé€‰é¡¹å¡å¯¼èˆª -->
        <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
            <div class="flex border-b" style="display: flex; width: 100%;">
                <button class="tab-btn active" onclick="switchTab('overview')" id="tab-overview" style="flex: 1;">
                    <span class="text-lg">ğŸ“Š</span>
                    <span class="ml-2">å®æ—¶æ¦‚è§ˆ</span>
                </button>
                <button class="tab-btn" onclick="switchTab('analysis')" id="tab-analysis" style="flex: 1;">
                    <span class="text-lg">ğŸ“ˆ</span>
                    <span class="ml-2">è¯¦ç»†åˆ†æ</span>
                </button>
                <button class="tab-btn" onclick="switchTab('ai')" id="tab-ai" style="flex: 1;">
                    <span class="text-lg">ğŸ¤–</span>
                    <span class="ml-2">AIæŠ¥å‘Š</span>
                </button>
                <button class="tab-btn" onclick="switchTab('manage')" id="tab-manage" style="flex: 1;">
                    <span class="text-lg">âš™ï¸</span>
                    <span class="ml-2">æ•°æ®ç®¡ç†</span>
                </button>
            </div>
        </div>

        <!-- ========== Tab 1: å®æ—¶æ¦‚è§ˆ ========== -->
        <div id="content-overview" class="tab-content">
            
            <!-- ç»Ÿè®¡å¡ç‰‡åŒº - å¤§å¡ç‰‡å¸¦æ¸å˜ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                
                <!-- å¡ç‰‡1: å·²å¡«å†™äººæ•° -->
                <div class="bg-white rounded-xl card-shadow p-6 transition-all duration-300 hover:scale-105">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-full gradient-blue flex items-center justify-center text-2xl">
                            ğŸ“
                        </div>
                        <span id="new-badge" class="text-xs bg-green-100 text-green-600 px-3 py-1 rounded-full font-semibold hidden">NEW</span>
                    </div>
                    <div class="text-gray-500 text-sm font-medium">å·²å¡«å†™äººæ•°</div>
                    <div class="text-5xl font-bold text-gray-900 mt-2 stat-number">
                        <span id="total-count">0</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">å®æ—¶æ›´æ–°</div>
                </div>

                <!-- å¡ç‰‡2: å¹³å‡ç”¨æ—¶ -->
                <div class="bg-white rounded-xl card-shadow p-6 transition-all duration-300 hover:scale-105">
                    <div class="w-12 h-12 rounded-full gradient-purple flex items-center justify-center text-2xl mb-4">
                        â±ï¸
                    </div>
                    <div class="text-gray-500 text-sm font-medium">å¹³å‡å®Œæˆæ—¶é—´</div>
                    <div class="text-5xl font-bold text-gray-900 mt-2 stat-number">
                        <span id="avg-time">0</span><span class="text-2xl text-gray-500 ml-1">ç§’</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        èŒƒå›´: <span id="min-time">-</span> ~ <span id="max-time">-</span>ç§’
                    </div>
                </div>

                <!-- å¡ç‰‡3: æœ€çƒ­é—¨ç—›ç‚¹ -->
                <div class="bg-white rounded-xl card-shadow p-6 transition-all duration-300 hover:scale-105">
                    <div class="w-12 h-12 rounded-full gradient-orange flex items-center justify-center text-2xl mb-4">
                        ğŸ”¥
                    </div>
                    <div class="text-gray-500 text-sm font-medium">TOP 1 ç—›ç‚¹</div>
                    <div class="text-xl font-bold text-gray-900 mt-2 leading-tight" id="top-pain" style="min-height: 3rem;">
                        åŠ è½½ä¸­...
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        <span id="top-pain-count">0</span> äººé€‰æ‹©
                    </div>
                </div>

                <!-- å¡ç‰‡4: æœ€æ–°æäº¤ -->
                <div class="bg-white rounded-xl card-shadow p-6 transition-all duration-300 hover:scale-105">
                    <div class="w-12 h-12 rounded-full gradient-green flex items-center justify-center text-2xl mb-4">
                        ğŸ•
                    </div>
                    <div class="text-gray-500 text-sm font-medium">æœ€æ–°æäº¤</div>
                    <div class="text-2xl font-bold text-gray-900 mt-2" id="latest-time">
                        ç­‰å¾…ä¸­...
                    </div>
                    <div class="text-xs text-gray-400 mt-2" id="status-text">
                        å®æ—¶ç›‘æ§ä¸­
                    </div>
                </div>

            </div>

            <!-- æ ¸å¿ƒå›¾è¡¨ - 2x2å¸ƒå±€ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                
                <!-- è¡Œä¸šåˆ†å¸ƒ -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š è¡Œä¸šåˆ†å¸ƒ</h3>
                    <div id="chart-industry" style="height: 320px;"></div>
                </div>

                <!-- è§’è‰²åˆ†å¸ƒ -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘” èŒä½è§’è‰²</h3>
                    <div id="chart-role" style="height: 320px;"></div>
                </div>

                <!-- ç—›ç‚¹çƒ­åŠ›å›¾ -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ¯ ç—›ç‚¹åœºæ™¯åˆ†å¸ƒ</h3>
                    <div id="chart-pain" style="height: 320px;"></div>
                </div>

                <!-- AIæ€åº¦åˆ†å¸ƒ -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ’­ å¯¹AIçš„æ€åº¦</h3>
                    <div id="chart-attitude" style="height: 320px;"></div>
                </div>

            </div>

        </div>

        <!-- ========== Tab 2: è¯¦ç»†åˆ†æ ========== -->
        <div id="content-analysis" class="tab-content hidden">
            
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“ˆ å…¨ç»´åº¦æ•°æ®åˆ†æ</h2>
                
                <!-- æ•°å­—åŒ–èƒ½åŠ› -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ’» æ•°å­—åŒ–å·¥å…·ä¹ æƒ¯</h3>
                    <div id="chart-digital" style="height: 300px;"></div>
                </div>

                <!-- AIä½¿ç”¨æƒ…å†µ -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ¤– AIå·¥å…·ä½¿ç”¨ç¨‹åº¦</h3>
                    <div id="chart-usage" style="height: 300px;"></div>
                </div>

                <!-- æœºæ„AIé˜¶æ®µ -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ¢ æœºæ„AIæ¨è¿›é˜¶æ®µ</h3>
                    <div id="chart-org" style="height: 300px;"></div>
                </div>

                <!-- ä¸ªäººè§’è‰² -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ‘¤ ä¸ªäººé¡¹ç›®è§’è‰²</h3>
                    <div id="chart-personal" style="height: 300px;"></div>
                </div>

                <!-- æ¨è¿›çº¦æŸ -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">âš ï¸ AIæ¨è¿›é¢ä¸´çš„çº¦æŸ</h3>
                    <div id="chart-constraints" style="height: 350px;"></div>
                </div>

            </div>

        </div>

        <!-- ========== Tab 3: AIæŠ¥å‘Š ========== -->
        <div id="content-ai" class="tab-content hidden">
            
            <!-- AIåˆ†ææ§åˆ¶åŒº -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ¤– AIæ¼”è®²å†…å®¹å»ºè®®</h2>
                        <p class="text-sm text-gray-500 mt-1">åŸºäºé—®å·æ•°æ®ï¼ŒAIä¸ºæ‚¨çš„æ¼”è®²æä¾›é’ˆå¯¹æ€§å»ºè®®</p>
                    </div>
                    <button id="btn-analyze" onclick="startAIAnalysis()" 
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold shadow-lg">
                        â–¶ï¸ å¼€å§‹AIåˆ†æ
                    </button>
                </div>
            </div>

            <!-- AIåˆ†æç»“æœå±•ç¤ºåŒº -->
            <div id="ai-result-container">
                
                <!-- åˆå§‹çŠ¶æ€ -->
                <div id="ai-initial" class="bg-white rounded-xl card-shadow p-12 text-center">
                    <div class="text-6xl mb-4">ğŸ¯</div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹AIåˆ†æ</h3>
                    <p class="text-gray-500">AIå°†æ ¹æ®å½“å‰é—®å·æ•°æ®ï¼Œä¸ºæ‚¨çš„æ¼”è®²æä¾›é’ˆå¯¹æ€§å»ºè®®</p>
                </div>

                <!-- åŠ è½½ä¸­ -->
                <div id="ai-loading" class="bg-white rounded-xl card-shadow p-12 text-center hidden">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">AIæ­£åœ¨åˆ†æä¸­...</h3>
                    <p class="text-gray-500">é¢„è®¡éœ€è¦30-60ç§’ï¼Œè¯·ç¨å€™</p>
                </div>

                <!-- ç»“æœæ˜¾ç¤º -->
                <div id="ai-results" class="hidden">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </div>

            </div>

        </div>

        <!-- ========== Tab 4: æ•°æ®ç®¡ç† ========== -->
        <div id="content-manage" class="tab-content hidden">
            
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ æ•°æ®ç®¡ç†</h2>
                
                <!-- å¯¼å‡ºåŠŸèƒ½ -->
                <div class="mb-8 pb-8 border-b">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“¥ æ•°æ®å¯¼å‡º</h3>
                    <div class="flex gap-4">
                        <button onclick="exportData()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            å¯¼å‡ºCSVæ–‡ä»¶
                        </button>
                        <button onclick="exportAnalysis()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            å¯¼å‡ºAIåˆ†ææŠ¥å‘Š
                        </button>
                    </div>
                </div>

                <!-- æ•°æ®ç»Ÿè®¡ -->
                <div class="mb-8 pb-8 border-b">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500">æ€»æäº¤æ•°</div>
                            <div class="text-2xl font-bold text-gray-900 mt-1"><span id="stat-total">0</span></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500">ç§»åŠ¨ç«¯</div>
                            <div class="text-2xl font-bold text-gray-900 mt-1"><span id="stat-mobile">0</span></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500">æ¡Œé¢ç«¯</div>
                            <div class="text-2xl font-bold text-gray-900 mt-1"><span id="stat-desktop">0</span></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500">å¹³å‡æ—¶é•¿</div>
                            <div class="text-2xl font-bold text-gray-900 mt-1"><span id="stat-avgtime">0</span>s</div>
                        </div>
                    </div>
                </div>

                <!-- å±é™©æ“ä½œ -->
                <div>
                    <h3 class="text-lg font-semibold text-red-600 mb-4">âš ï¸ å±é™©æ“ä½œ</h3>
                    <div class="bg-red-50 rounded-lg p-4">
                        <p class="text-sm text-red-700 mb-4">æ¸…ç©ºæ•°æ®åå°†æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                        <button onclick="clearAllData()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            æ¸…ç©ºæ‰€æœ‰é—®å·æ•°æ®
                        </button>
                    </div>
                </div>

            </div>

        </div>

    </div>
</div>

<!-- ========== JavaScriptæ ¸å¿ƒé€»è¾‘ ========== -->
<script>
// ===== åˆå§‹åŒ– =====
window.onload = async function() {
    // åˆå§‹åŒ–Supabase
    supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
    
    // åˆå§‹åŒ–å›¾è¡¨
    initCharts();
    
    // åŠ è½½æ•°æ®
    await loadData();
    
    // è®¢é˜…å®æ—¶æ›´æ–°
    subscribeRealtime();
    
    // å®šæ—¶æ›´æ–°æœ€æ–°æäº¤æ—¶é—´
    setInterval(updateLatestTime, 5000);
    
    // å°è¯•åŠ è½½å·²æœ‰çš„AIåˆ†æ
    await loadExistingAnalysis();
};

// ===== Tabåˆ‡æ¢ =====
function switchTab(tabName) {
    // éšè—æ‰€æœ‰Tabå†…å®¹
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // ç§»é™¤æ‰€æœ‰TabæŒ‰é’®çš„activeçŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    // æ˜¾ç¤ºé€‰ä¸­çš„Tab
    document.getElementById('content-' + tabName).classList.remove('hidden');
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // å¦‚æœåˆ‡æ¢åˆ°å›¾è¡¨Tabï¼Œé‡ç»˜å›¾è¡¨ï¼ˆè§£å†³åˆ‡æ¢åå›¾è¡¨ä¸æ˜¾ç¤ºçš„é—®é¢˜ï¼‰
    if (tabName === 'analysis') {
        setTimeout(() => {
            Object.values(charts).forEach(chart => chart.resize());
        }, 100);
    }
}

// ===== åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨ =====
function initCharts() {
    charts.industry = echarts.init(document.getElementById('chart-industry'));
    charts.role = echarts.init(document.getElementById('chart-role'));
    charts.pain = echarts.init(document.getElementById('chart-pain'));
    charts.attitude = echarts.init(document.getElementById('chart-attitude'));
    charts.digital = echarts.init(document.getElementById('chart-digital'));
    charts.usage = echarts.init(document.getElementById('chart-usage'));
    charts.org = echarts.init(document.getElementById('chart-org'));
    charts.personal = echarts.init(document.getElementById('chart-personal'));
    charts.constraints = echarts.init(document.getElementById('chart-constraints'));
}

// ===== åŠ è½½æ•°æ® =====
async function loadData() {
    try {
        console.log('å¼€å§‹åŠ è½½æ•°æ®...');
        
        // æ–¹æ³•1: ä½¿ç”¨Supabase RPCå‡½æ•°
        try {
            const { data: stats, error } = await supabase
                .rpc('get_session_statistics', { p_session_id: CONFIG.SESSION_ID });
            
            if (error) {
                console.error('Supabase RPCé”™è¯¯:', error);
                throw error;
            }
            
            if (stats) {
                console.log('âœ… é€šè¿‡Supabase RPCåŠ è½½æˆåŠŸ', stats);
                statsData = stats;
                updateStatCards(stats);
                updateAllCharts(stats);
                return;
            }
        } catch (rpcError) {
            console.warn('Supabase RPCå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ:', rpcError);
        }
        
        // æ–¹æ³•2: å¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨åç«¯API
        console.log('ä½¿ç”¨åç«¯APIåŠ è½½æ•°æ®...');
        const response = await fetch(`${CONFIG.API_BASE_URL}/api/stats?session_id=${CONFIG.SESSION_ID}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const stats = await response.json();
        console.log('âœ… é€šè¿‡åç«¯APIåŠ è½½æˆåŠŸ', stats);
        
        statsData = stats;
        updateStatCards(stats);
        updateAllCharts(stats);
        
    } catch (error) {
        console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
        
        // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
        const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
        alert(`æ•°æ®åŠ è½½å¤±è´¥: ${errorMsg}\n\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ\n2. Supabaseé…ç½®æ˜¯å¦æ­£ç¡®\n3. æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯`);
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        document.getElementById('total-count').textContent = '0';
        document.getElementById('avg-time').textContent = '0';
        document.getElementById('top-pain').textContent = 'æš‚æ— æ•°æ®';
    }
}

// ===== æ›´æ–°ç»Ÿè®¡å¡ç‰‡ =====
function updateStatCards(stats) {
    const totalCount = stats.total_responses || 0;
    const avgTime = Math.round((stats.avg_completion_time || 0) / 60 * 10) / 10;
    
    // æ›´æ–°æ•°å­—ï¼ˆå¸¦åŠ¨ç”»ï¼‰
    const countElement = document.getElementById('total-count');
    if (countElement && window.countUp && window.countUp.CountUp) {
        try {
            const counter = new window.countUp.CountUp(countElement, totalCount, {
                duration: 1.5,
                useEasing: true
            });
            counter.start();
        } catch (e) {
            // å¦‚æœCountUpå¤±è´¥ï¼Œç›´æ¥æ›´æ–°æ•°å­—
            countElement.textContent = totalCount;
        }
    } else {
        // å¦‚æœCountUpæœªåŠ è½½ï¼Œç›´æ¥æ›´æ–°æ•°å­—
        countElement.textContent = totalCount;
    }
    
    document.getElementById('avg-time').textContent = stats.avg_completion_time || 0;
    document.getElementById('min-time').textContent = '60';  // å¯ä»¥ä»åŸå§‹æ•°æ®è®¡ç®—
    document.getElementById('max-time').textContent = '300';
    
    // æœ€çƒ­é—¨ç—›ç‚¹
    const painPoints = stats.pain_points || {};
    if (Object.keys(painPoints).length > 0) {
        const topPain = Object.entries(painPoints).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('top-pain').textContent = formatPainPoint(topPain[0]);
        document.getElementById('top-pain-count').textContent = topPain[1];
    }
    
    // ç®¡ç†Tabç»Ÿè®¡
    document.getElementById('stat-total').textContent = totalCount;
    document.getElementById('stat-mobile').textContent = stats.mobile_count || 0;
    document.getElementById('stat-desktop').textContent = stats.desktop_count || 0;
    document.getElementById('stat-avgtime').textContent = stats.avg_completion_time || 0;
}

// ===== æ›´æ–°æ‰€æœ‰å›¾è¡¨ =====
function updateAllCharts(stats) {
    console.log('ğŸ“Š æ›´æ–°å›¾è¡¨æ•°æ®:', stats);
    
    // ç¡®ä¿å›¾è¡¨å·²åˆå§‹åŒ–
    if (!charts.industry || !charts.role) {
        console.warn('âš ï¸ å›¾è¡¨æœªåˆå§‹åŒ–ï¼Œå»¶è¿Ÿ500msåé‡è¯•');
        setTimeout(() => updateAllCharts(stats), 500);
        return;
    }
    
    // Tab1å›¾è¡¨
    updateIndustryChart(stats.industries || {});
    updateRoleChart(stats.roles || {});
    updatePainChart(stats.pain_points || {});
    updateAttitudeChart(stats.attitudes || {});
    
    // Tab2å›¾è¡¨
    updateDigitalChart(stats.digital_habits || {});
    updateUsageChart(stats.ai_usages || {});
    updateOrgChart(stats.org_stages || {});
    updatePersonalChart(stats.personal_roles || {});
    updateConstraintsChart(stats.constraints || {});
    
    // å¼ºåˆ¶é‡ç»˜æ‰€æœ‰å›¾è¡¨
    setTimeout(() => {
        Object.values(charts).forEach(chart => {
            if (chart && chart.resize) {
                chart.resize();
            }
        });
    }, 100);
}

// ===== è¡Œä¸šåˆ†å¸ƒå›¾ï¼ˆé¥¼å›¾ï¼‰=====
function updateIndustryChart(data) {
    if (!data || Object.keys(data).length === 0) {
        console.warn('âš ï¸ è¡Œä¸šæ•°æ®ä¸ºç©º');
        charts.industry.setOption({
            title: { text: 'æš‚æ— æ•°æ®', left: 'center', top: 'center', textStyle: { color: '#ccc', fontSize: 16 } }
        });
        return;
    }
    
    const chartData = Object.entries(data).map(([name, value]) => ({
        name: formatIndustry(name),
        value
    }));
    
    console.log('ğŸ“Š è¡Œä¸šåˆ†å¸ƒæ•°æ®:', chartData);
    
    charts.industry.setOption({
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: true,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: { show: true, formatter: '{b}\n{d}%' },
            emphasis: {
                label: { show: true, fontSize: 16, fontWeight: 'bold' }
            },
            data: chartData,
            color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4']
        }]
    });
}

// ===== è§’è‰²åˆ†å¸ƒå›¾ï¼ˆæŸ±çŠ¶å›¾ï¼‰=====
function updateRoleChart(data) {
    if (!data || Object.keys(data).length === 0) {
        console.warn('âš ï¸ è§’è‰²æ•°æ®ä¸ºç©º');
        charts.role.setOption({
            title: { text: 'æš‚æ— æ•°æ®', left: 'center', top: 'center', textStyle: { color: '#ccc', fontSize: 16 } }
        });
        return;
    }
    
    const labels = Object.keys(data).map(formatRole);
    const values = Object.values(data);
    
    console.log('ğŸ“Š è§’è‰²åˆ†å¸ƒæ•°æ®:', { labels, values });
    
    charts.role.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        xAxis: {
            type: 'category',
            data: labels,
            axisLabel: { rotate: 30, interval: 0, fontSize: 11 }
        },
        yAxis: { type: 'value' },
        series: [{
            type: 'bar',
            data: values,
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#83bff6' },
                    { offset: 1, color: '#188df0' }
                ]),
                borderRadius: [6, 6, 0, 0]
            },
            label: { show: true, position: 'top' }
        }]
    });
}

// ===== ç—›ç‚¹çƒ­åŠ›å›¾ï¼ˆæ¨ªå‘æ¡å½¢å›¾ï¼‰=====
function updatePainChart(data) {
    const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
    const labels = sortedData.map(([k, v]) => formatPainPoint(k));
    const values = sortedData.map(([k, v]) => v);
    
    charts.pain.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        grid: { left: '35%', right: '10%' },
        xAxis: { type: 'value' },
        yAxis: {
            type: 'category',
            data: labels,
            axisLabel: { fontSize: 11 }
        },
        series: [{
            type: 'bar',
            data: values,
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                    { offset: 0, color: '#fa709a' },
                    { offset: 1, color: '#fee140' }
                ]),
                borderRadius: [0, 6, 6, 0]
            },
            label: { show: true, position: 'right' }
        }]
    });
}

// ===== AIæ€åº¦åˆ†å¸ƒï¼ˆé›·è¾¾å›¾ï¼‰=====
function updateAttitudeChart(data) {
    const labels = ['ç§¯ææ‹¥æŠ±', 'ç†æ€§è°¨æ…', 'è§‚æœ›ç­‰å¾…', 'å­˜ç–‘æ‹…å¿§', 'ä¸ç¡®å®š'];
    const values = [data['1'] || 0, data['2'] || 0, data['3'] || 0, data['4'] || 0, data['5'] || 0];
    
    charts.attitude.setOption({
        tooltip: {},
        radar: {
            indicator: labels.map(name => ({ name, max: Math.max(...values) + 2 })),
            radius: '65%'
        },
        series: [{
            type: 'radar',
            data: [{
                value: values,
                name: 'AIæ€åº¦åˆ†å¸ƒ',
                areaStyle: {
                    color: new echarts.graphic.RadialGradient(0.5, 0.5, 1, [{
                        color: 'rgba(103, 126, 234, 0.1)',
                        offset: 0
                    }, {
                        color: 'rgba(103, 126, 234, 0.9)',
                        offset: 1
                    }])
                }
            }]
        }]
    });
}

// ===== æ•°å­—åŒ–ä¹ æƒ¯ï¼ˆæŸ±çŠ¶å›¾ï¼‰=====
function updateDigitalChart(data) {
    const labels = ['åŸºç¡€å·¥å…·', 'Excelé«˜çº§+BI', 'SQL/è„šæœ¬', 'æ­å»ºè‡ªåŠ¨åŒ–'];
    const values = [data['1'] || 0, data['2'] || 0, data['3'] || 0, data['4'] || 0];
    
    charts.digital.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: labels },
        yAxis: { type: 'value' },
        series: [{
            type: 'bar',
            data: values,
            itemStyle: { color: '#5470c6', borderRadius: [6, 6, 0, 0] },
            label: { show: true, position: 'top' }
        }]
    });
}

// ===== AIä½¿ç”¨ç¨‹åº¦ï¼ˆæŸ±çŠ¶å›¾ï¼‰=====
function updateUsageChart(data) {
    const labels = ['è¿˜æ²¡ç”¨è¿‡', 'å¶å°”å°è¯•', 'ç»å¸¸ä½¿ç”¨', 'æ·±åº¦åº”ç”¨', 'å›¢é˜Ÿæ¨å¹¿'];
    const values = [data['1'] || 0, data['2'] || 0, data['3'] || 0, data['4'] || 0, data['5'] || 0];
    
    charts.usage.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: labels },
        yAxis: { type: 'value' },
        series: [{
            type: 'bar',
            data: values,
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#fbc2eb' },
                    { offset: 1, color: '#a6c1ee' }
                ]),
                borderRadius: [6, 6, 0, 0]
            },
            label: { show: true, position: 'top' }
        }]
    });
}

// ===== æœºæ„é˜¶æ®µï¼ˆæŸ±çŠ¶å›¾ï¼‰=====
function updateOrgChart(data) {
    const labels = ['è°ƒç ”è®¨è®º', 'å°èŒƒå›´è¯•ç‚¹', 'å¤šåœºæ™¯ä½¿ç”¨', 'æ•´ä½“è§„åˆ’', 'ä¸ç¡®å®š'];
    const values = [data['1'] || 0, data['2'] || 0, data['3'] || 0, data['4'] || 0, data['5'] || 0];
    
    charts.org.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: labels },
        yAxis: { type: 'value' },
        series: [{
            type: 'bar',
            data: values,
            itemStyle: { color: '#91cc75', borderRadius: [6, 6, 0, 0] },
            label: { show: true, position: 'top' }
        }]
    });
}

// ===== ä¸ªäººè§’è‰²ï¼ˆé¥¼å›¾ï¼‰=====
function updatePersonalChart(data) {
    const labels = { '1': 'ä½¿ç”¨è€…', '2': 'å‚ä¸è€…', '3': 'æ¨åŠ¨è€…', '4': 'è§‚å¯Ÿè€…' };
    const chartData = Object.entries(data).map(([k, v]) => ({
        name: labels[k] || k,
        value: v
    }));
    
    charts.personal.setOption({
        tooltip: { trigger: 'item' },
        series: [{
            type: 'pie',
            radius: '60%',
            data: chartData,
            emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
        }]
    });
}

// ===== æ¨è¿›çº¦æŸï¼ˆæ¨ªå‘æ¡å½¢å›¾ï¼‰=====
function updateConstraintsChart(data) {
    if (!data || Object.keys(data).length === 0) {
        charts.constraints.setOption({
            title: { text: 'æš‚æ— æ•°æ®', left: 'center', top: 'center', textStyle: { color: '#ccc' } }
        });
        return;
    }
    
    const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
    const labels = sortedData.map(([k, v]) => formatConstraint(k));
    const values = sortedData.map(([k, v]) => v);
    
    charts.constraints.setOption({
        tooltip: { trigger: 'axis' },
        grid: { left: '25%', right: '10%' },
        xAxis: { type: 'value' },
        yAxis: { type: 'category', data: labels, axisLabel: { fontSize: 11 } },
        series: [{
            type: 'bar',
            data: values,
            itemStyle: { color: '#ee6666', borderRadius: [0, 6, 6, 0] },
            label: { show: true, position: 'right' }
        }]
    });
}

// ===== æ ¼å¼åŒ–å‡½æ•° =====
function formatIndustry(key) {
    const map = {
        'é“¶è¡Œ': 'é“¶è¡Œ',
        'è¯åˆ¸å…¬å¸': 'è¯åˆ¸',
        'ä¿é™©å…¬å¸': 'ä¿é™©',
        'æœŸè´§å…¬å¸': 'æœŸè´§',
        'åŸºé‡‘å…¬å¸ï¼ˆå…¬å‹Ÿ/ç§å‹Ÿ/èµ„ç®¡ï¼‰': 'åŸºé‡‘',
        'é‡‘èç§‘æŠ€å…¬å¸ï¼ˆéæŒç‰Œï¼‰': 'é‡‘èç§‘æŠ€',
        'å…¶ä»–æŒç‰Œé‡‘èæœºæ„ï¼ˆå¦‚æ¶ˆè´¹é‡‘èã€é‡‘èç§Ÿèµã€é‡‘æ§é›†å›¢ç­‰ï¼‰': 'å…¶ä»–æŒç‰Œ',
        'å…¶ä»–è¡Œä¸š': 'å…¶ä»–'
    };
    return map[key] || key;
}

function formatRole(key) {
    const map = {
        'æˆ˜ç•¥/ç®¡ç†': 'æˆ˜ç•¥ç®¡ç†',
        'äº§å“å¼€å‘/åˆ›æ–°': 'äº§å“åˆ›æ–°',
        'é£æ§/åˆè§„': 'é£æ§åˆè§„',
        'æŠ•èµ„/ç ”ç©¶': 'æŠ•èµ„ç ”ç©¶',
        'æ•°æ®åˆ†æ/å»ºæ¨¡': 'æ•°æ®åˆ†æ',
        'æŠ€æœ¯å¼€å‘': 'æŠ€æœ¯å¼€å‘',
        'IT/è¿ç»´': 'ITè¿ç»´',
        'å…¶ä»–æ–¹å‘': 'å…¶ä»–'
    };
    return map[key] || key;
}

function formatPainPoint(key) {
    const map = {
        'report_integration': 'æŠ¥è¡¨æ•´åˆ',
        'doc_writing': 'å‘¨æŠ¥æœˆæŠ¥æ’°å†™',
        'research_reading': 'ç ”æŠ¥å¿«é€Ÿé˜…è¯»',
        'customer_qa': 'å®¢æˆ·é—®é¢˜ç­”ç–‘',
        'compliance_review': 'åˆè§„é£æ§å®¡æŸ¥',
        'data_reconciliation': 'æ•°æ®æ ¸å¯¹å¯¹è´¦',
        'policy_search': 'å†…éƒ¨åˆ¶åº¦æŸ¥è¯¢',
        'code_dev': 'ä»£ç è„šæœ¬å¼€å‘',
        'none': 'æš‚æ— æ˜ç¡®ç—›ç‚¹'
    };
    return map[key] || key;
}

function formatConstraint(key) {
    const map = {
        'data_security': 'æ•°æ®å®‰å…¨',
        'cost_budget': 'æˆæœ¬é¢„ç®—',
        'tech_infra': 'æŠ€æœ¯åŸºç¡€è®¾æ–½',
        'talent_shortage': 'ç¼ºä¹ä¸“ä¸šäººæ‰',
        'integration_complexity': 'ç³»ç»Ÿé›†æˆå¤æ‚',
        'roi_unclear': 'æŠ•å…¥äº§å‡ºä¸æ˜',
        'internal_resistance': 'å†…éƒ¨æ¨åŠ¨é˜»åŠ›',
        'regulatory_compliance': 'ç›‘ç®¡åˆè§„æŒ‘æˆ˜',
        'explainability_trust': 'å¯è§£é‡Šæ€§ä¸è¶³',
        'vendor_selection': 'ä¾›åº”å•†é€‰æ‹©å›°éš¾',
        'tech_implementation': 'æŠ€æœ¯è½åœ°å›°éš¾'
    };
    return map[key] || key;
}

// ===== å®æ—¶è®¢é˜… =====
function subscribeRealtime() {
    supabase
        .channel('responses_channel')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'responses',
            filter: `session_id=eq.${CONFIG.SESSION_ID}`
        }, payload => {
            console.log('æ–°æäº¤:', payload);
            // æ˜¾ç¤º"NEW"å¾½ç« 
            const badge = document.getElementById('new-badge');
            badge.classList.remove('hidden');
            setTimeout(() => badge.classList.add('hidden'), 3000);
            
            // åˆ·æ–°æ•°æ®
            loadData();
        })
        .subscribe();
}

// ===== æ›´æ–°æœ€æ–°æäº¤æ—¶é—´ =====
function updateLatestTime() {
    // ä»statsDataè·å–æœ€æ–°æ—¶é—´æˆ–ç›´æ¥æŸ¥è¯¢
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const minutesAgo = Math.floor(Math.random() * 10);  // ç¤ºä¾‹ï¼Œå®é™…åº”ä»æ•°æ®è®¡ç®—
    
    document.getElementById('latest-time').textContent = `${minutesAgo}åˆ†é’Ÿå‰`;
}

// ===== AIåˆ†æåŠŸèƒ½ =====
async function startAIAnalysis() {
    document.getElementById('ai-initial').classList.add('hidden');
    document.getElementById('ai-results').classList.add('hidden');
    document.getElementById('ai-loading').classList.remove('hidden');
    document.getElementById('btn-analyze').disabled = true;
    document.getElementById('btn-analyze').innerHTML = 'â³ åˆ†æä¸­...';
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/api/analyze`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: CONFIG.SESSION_ID })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'åˆ†æå¤±è´¥');
        }
        
        const result = await response.json();
        
        if (result.success) {
            analysisData = result.data.analysis;
            displayAIResults(analysisData);
        }
        
    } catch (error) {
        console.error('AIåˆ†æå¤±è´¥:', error);
        alert('AIåˆ†æå¤±è´¥: ' + error.message);
        document.getElementById('ai-initial').classList.remove('hidden');
    } finally {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('btn-analyze').disabled = false;
        document.getElementById('btn-analyze').innerHTML = 'â–¶ï¸ é‡æ–°åˆ†æ';
    }
}

// ===== åŠ è½½å·²æœ‰çš„AIåˆ†æ =====
async function loadExistingAnalysis() {
    try {
        const { data, error } = await supabase
            .from('analysis_results')
            .select('*')
            .eq('session_id', CONFIG.SESSION_ID)
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
            try {
                const analysisJson = JSON.parse(data[0].analysis_text);
                analysisData = analysisJson;
                displayAIResults(analysisJson);
                document.getElementById('ai-initial').classList.add('hidden');
                document.getElementById('btn-analyze').innerHTML = 'ğŸ”„ é‡æ–°åˆ†æ';
            } catch (e) {
                console.error('è§£æAIç»“æœå¤±è´¥:', e);
            }
        }
    } catch (error) {
        console.error('åŠ è½½AIåˆ†æå¤±è´¥:', error);
    }
}

// ===== æ¸²æŸ“AIåˆ†æç»“æœï¼ˆJSONç»“æ„ï¼‰=====
function displayAIResults(data) {
    const container = document.getElementById('ai-results');
    container.innerHTML = '';
    
    // å¦‚æœæ˜¯æ—§çš„æ–‡æœ¬æ ¼å¼
    if (data.raw_text) {
        container.innerHTML = `<div class="bg-white rounded-xl card-shadow p-6">
            <div class="prose max-w-none">${data.raw_text.replace(/\n/g, '<br>')}</div>
        </div>`;
        container.classList.remove('hidden');
        return;
    }
    
    // 1. å—ä¼—åˆ†ææ€»è§ˆ
    if (data.audience_analysis) {
        const audience = data.audience_analysis;
        const html = `
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ‘¥ å—ä¼—ç”»åƒæ€»è§ˆ</h3>
            <p class="text-gray-700 mb-6 leading-relaxed">${audience.summary}</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                ${audience.key_characteristics.map(item => `
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                        <div class="text-sm font-semibold text-blue-900 mb-2">${item.dimension}</div>
                        <div class="text-xs text-blue-700 mb-1">${item.insight}</div>
                        <div class="text-lg font-bold text-blue-600">${item.percentage}</div>
                    </div>
                `).join('')}
            </div>
            
            <h4 class="text-lg font-semibold text-gray-700 mb-3">å‡†å¤‡åº¦è¯„åˆ†</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl font-bold text-blue-600">${audience.readiness_score.technical.score}</div>
                    <div>
                        <div class="text-sm font-semibold text-gray-700">æŠ€æœ¯å‡†å¤‡åº¦</div>
                        <div class="text-xs text-gray-500">${audience.readiness_score.technical.description}</div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-4xl font-bold text-green-600">${audience.readiness_score.mindset.score}</div>
                    <div>
                        <div class="text-sm font-semibold text-gray-700">è®¤çŸ¥æ€åº¦</div>
                        <div class="text-xs text-gray-500">${audience.readiness_score.mindset.description}</div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-4xl font-bold text-purple-600">${audience.readiness_score.organizational.score}</div>
                    <div>
                        <div class="text-sm font-semibold text-gray-700">ç»„ç»‡æ”¯æŒåº¦</div>
                        <div class="text-xs text-gray-500">${audience.readiness_score.organizational.description}</div>
                    </div>
                </div>
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }
    
    // 2. å…³é”®å‘ç°
    if (data.key_findings && data.key_findings.length > 0) {
        const priorityColors = {
            high: 'red',
            medium: 'yellow',
            low: 'green'
        };
        
        const html = `
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ’¡ å…³é”®å‘ç°</h3>
            ${data.key_findings.map(item => {
                const color = priorityColors[item.priority];
                return `
                <div class="border-l-4 border-${color}-500 bg-${color}-50 rounded-r-lg p-4 mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-1 bg-${color}-200 text-${color}-800 text-xs font-semibold rounded">${item.priority.toUpperCase()}</span>
                        <h4 class="text-lg font-semibold text-gray-800">${item.title}</h4>
                    </div>
                    <ul class="list-disc list-inside text-gray-700 mb-2">
                        ${item.details.map(d => `<li class="text-sm">${d}</li>`).join('')}
                    </ul>
                    <div class="text-sm text-gray-600 italic">â†’ ${item.implication}</div>
                </div>
                `;
            }).join('')}
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }
    
    // 3. æ¼”è®²å†…å®¹å»ºè®®
    if (data.content_recommendations) {
        const rec = data.content_recommendations;
        
        // Part 1: æ¦‚å¿µéƒ¨åˆ†
        if (rec.part1_concepts) {
            const html = `
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¦‚å¿µä¸è¶‹åŠ¿å»ºè®®</h3>
                
                <div class="mb-4">
                    <div class="text-sm font-semibold text-gray-600 mb-2">å»ºè®®æ·±åº¦å±‚çº§</div>
                    <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full font-semibold">${rec.part1_concepts.depth_level}</span>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm font-semibold text-gray-600 mb-2">åº”è¯¥å¼ºè°ƒ</div>
                    <div class="flex flex-wrap gap-2">
                        ${rec.part1_concepts.emphasis.map(item => `
                            <span class="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">âœ“ ${item}</span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm font-semibold text-gray-600 mb-3">å»ºè®®è¯é¢˜</div>
                    ${rec.part1_concepts.suggested_topics.map(item => `
                        <div class="bg-gray-50 rounded-lg p-3 mb-2">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-semibold text-gray-800">${item.topic}</span>
                                <span class="text-xs text-gray-500">${item.time_allocation}</span>
                            </div>
                            <div class="text-sm text-gray-600">${item.rationale}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <div class="text-sm font-semibold text-gray-600 mb-2">åº”è¯¥é¿å…</div>
                    <div class="flex flex-wrap gap-2">
                        ${rec.part1_concepts.avoid.map(item => `
                            <span class="px-3 py-1 bg-red-100 text-red-800 text-sm rounded-full">âœ— ${item}</span>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
        
        // Part 2: æ¡ˆä¾‹å»ºè®®
        if (rec.part2_cases) {
            const cases = [
                { key: 'case1_resume', title: 'æ¡ˆä¾‹1: æ™ºèƒ½ç®€å†ç­›é€‰', icon: 'ğŸ“„' },
                { key: 'case2_contract', title: 'æ¡ˆä¾‹2: åˆåŒå®¡æŸ¥å·¥ä½œæµ', icon: 'ğŸ“' },
                { key: 'case3_research', title: 'æ¡ˆä¾‹3: ä¿¡ç”¨å€ºè°ƒç ”æŠ¥å‘Š', icon: 'ğŸ“Š' }
            ];
            
            let html = `
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¬ ç¬¬äºŒéƒ¨åˆ†ï¼šæ¡ˆä¾‹æ¼”ç¤ºå»ºè®®</h3>
            `;
            
            cases.forEach(({ key, title, icon }) => {
                if (rec.part2_cases[key]) {
                    const caseData = rec.part2_cases[key];
                    html += `
                    <div class="border-2 border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">${icon}</span>
                            <h4 class="text-lg font-bold text-gray-800">${title}</h4>
                            <span class="ml-auto px-3 py-1 bg-blue-100 text-blue-800 font-semibold rounded">ç›¸å…³åº¦: ${caseData.relevance_score}/10</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="text-sm font-semibold text-gray-600 mb-1">æ¼”ç¤ºé‡ç‚¹</div>
                            <ul class="list-disc list-inside text-sm text-gray-700">
                                ${caseData.emphasis.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <div class="text-sm font-semibold text-gray-600 mb-1">æ¼”ç¤ºå»ºè®®</div>
                            <p class="text-sm text-gray-700">${caseData.demo_suggestions}</p>
                        </div>
                        
                        <div>
                            <div class="text-sm font-semibold text-gray-600 mb-1">å¯èƒ½è¢«é—®çš„é—®é¢˜</div>
                            <div class="flex flex-wrap gap-2">
                                ${caseData.qa_predictions.map(q => `
                                    <span class="px-2 py-1 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-200">â“ ${q}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    `;
                }
            });
            
            // æ¡ˆä¾‹é¡ºåºå»ºè®®
            if (rec.part2_cases.case_order_suggestion) {
                html += `
                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                    <div class="text-sm font-semibold text-blue-900 mb-2">ğŸ“Œ å»ºè®®æ¡ˆä¾‹é¡ºåº</div>
                    <div class="text-blue-800 mb-2">
                        æ¡ˆä¾‹${rec.part2_cases.case_order_suggestion.recommended_order.join(' â†’ æ¡ˆä¾‹')}
                    </div>
                    <div class="text-sm text-blue-700">${rec.part2_cases.case_order_suggestion.rationale}</div>
                </div>
                `;
            }
            
            // çµæ´»æ¡ˆä¾‹
            if (rec.part2_cases.flexible_case) {
                const flexColor = rec.part2_cases.flexible_case.should_present ? 'green' : 'gray';
                html += `
                <div class="bg-${flexColor}-50 border-2 border-${flexColor}-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ğŸ­</span>
                        <h4 class="text-lg font-bold text-gray-800">çµæ´»æ¡ˆä¾‹ï¼šåˆ¶é€ ä¸šæˆæƒæŠ¥ä»·</h4>
                        <span class="ml-auto px-3 py-1 bg-${flexColor}-200 text-${flexColor}-800 font-semibold rounded">
                            ${rec.part2_cases.flexible_case.should_present ? 'âœ“ å»ºè®®æ¼”ç¤º' : 'Ã— å¯è·³è¿‡'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-700">${rec.part2_cases.flexible_case.rationale}</p>
                </div>
                `;
            }
            
            html += `</div>`;
            container.insertAdjacentHTML('beforeend', html);
        }
        
        // æ—¶é—´åˆ†é…
        if (rec.time_allocation) {
            const ta = rec.time_allocation;
            const html = `
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">â° æ—¶é—´åˆ†é…å»ºè®®</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">ç¬¬ä¸€éƒ¨åˆ†ï¼ˆæ¦‚å¿µï¼‰</h4>
                        ${Object.entries(ta.part1_breakdown).map(([k, v]) => `
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-600">${k}</span>
                                <span class="font-semibold text-blue-600">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">ç¬¬äºŒéƒ¨åˆ†ï¼ˆæ¡ˆä¾‹ï¼‰</h4>
                        ${Object.entries(ta.part2_breakdown).map(([k, v]) => `
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-600">${k}</span>
                                <span class="font-semibold text-green-600">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-gray-600 mb-1">è°ƒæ•´ç†ç”±</div>
                    <p class="text-sm text-gray-700">${ta.adjustment_rationale}</p>
                </div>
            </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
    }
    
    // 4. äº’åŠ¨è®¾è®¡
    if (data.interaction_design) {
        const inter = data.interaction_design;
        let html = `
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸª äº’åŠ¨ç¯èŠ‚è®¾è®¡</h3>
        `;
        
        // ç°åœºPoCå»ºè®®
        if (inter.live_poc_suggestions && inter.live_poc_suggestions.length > 0) {
            html += `
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">ğŸ’¡ ç°åœºæ¼”ç¤ºå»ºè®®</h4>
                ${inter.live_poc_suggestions.map(poc => `
                    <div class="bg-purple-50 border-l-4 border-purple-500 rounded-r-lg p-4 mb-3">
                        <div class="font-semibold text-purple-900 mb-2">${poc.scenario}</div>
                        <div class="text-sm text-gray-700 mb-2">${poc.description}</div>
                        <div class="text-sm text-gray-600 mb-2"><strong>ä¸ºä»€ä¹ˆï¼š</strong>${poc.why}</div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>ğŸ“‹ å‡†å¤‡: ${poc.preparation}</span>
                            <span>â±ï¸ ${poc.time_needed}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            `;
        }
        
        // Q&Aç­–ç•¥
        if (inter.qa_strategy) {
            html += `
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">â“ Q&Aç¯èŠ‚ç­–ç•¥</h4>
                <div class="bg-yellow-50 rounded-lg p-4 mb-3">
                    <div class="text-sm font-semibold text-yellow-900 mb-2">é¢„æµ‹çš„é«˜é¢‘é—®é¢˜</div>
                    ${inter.qa_strategy.predicted_questions.map(q => `
                        <div class="mb-3">
                            <div class="text-sm font-semibold text-gray-800 mb-1">Q: ${q.question}</div>
                            <div class="text-sm text-gray-700">A: ${q.suggested_answer}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            `;
        }
        
        // è®¨è®ºè¯é¢˜
        if (inter.discussion_topics && inter.discussion_topics.length > 0) {
            html += `
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-3">ğŸ’¬ è®¨è®ºè¯é¢˜</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${inter.discussion_topics.map(topic => `
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="font-semibold text-gray-800 mb-1">${topic.topic}</div>
                            <div class="text-xs text-gray-600 mb-1">å¼•å…¥: ${topic.starter}</div>
                            <div class="text-xs text-gray-500">ç›®æ ‡: ${topic.expected_outcome}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            `;
        }
        
        html += `</div>`;
        container.insertAdjacentHTML('beforeend', html);
    }
    
    // 5. å—ä¼—åˆ†å±‚
    if (data.audience_segments && data.audience_segments.length > 0) {
        const html = `
        <div class="bg-white rounded-xl card-shadow p-6 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ‘¥ å—ä¼—åˆ†å±‚åˆ†æ</h3>
            <div class="grid grid-cols-1 md:grid-cols-${Math.min(data.audience_segments.length, 3)} gap-4">
                ${data.audience_segments.map(seg => `
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-gray-800">${seg.segment_name}</h4>
                            <span class="text-2xl font-bold text-blue-600">${seg.percentage}%</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${seg.count}äºº Â· ${seg.characteristics}</div>
                        <div class="mb-3">
                            <div class="text-xs font-semibold text-gray-500 mb-1">ç—›ç‚¹</div>
                            ${seg.pain_points.map(p => `<div class="text-xs text-red-600">â€¢ ${p}</div>`).join('')}
                        </div>
                        <div class="bg-blue-50 rounded p-2">
                            <div class="text-xs font-semibold text-blue-900 mb-1">äº’åŠ¨ç­–ç•¥</div>
                            <div class="text-xs text-blue-700">${seg.engagement_strategy}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }
    
    // 6. å®ç”¨æŠ€å·§
    if (data.practical_tips) {
        const tips = data.practical_tips;
        const html = `
        <div class="bg-white rounded-xl card-shadow p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ¯ å®ç”¨æ¼”è®²æŠ€å·§</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-green-900 mb-2">ğŸš€ å¼€åœºç ´å†°</div>
                    <p class="text-sm text-green-800">${tips.opening}</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm font-semibold text-blue-900 mb-2">ğŸ”„ æ¡ˆä¾‹è¿‡æ¸¡</div>
                    <p class="text-sm text-blue-800">${tips.transitions}</p>
                </div>
            </div>
            
            <div class="bg-purple-50 rounded-lg p-4 mb-4">
                <div class="text-sm font-semibold text-purple-900 mb-2">ğŸ’¬ ä¿æŒäº’åŠ¨</div>
                <div class="flex flex-wrap gap-2">
                    ${tips.engagement_techniques.map(t => `
                        <span class="px-3 py-1 bg-purple-200 text-purple-800 text-xs rounded-full">${t}</span>
                    `).join('')}
                </div>
            </div>
            
            <div class="bg-orange-50 rounded-lg p-4">
                <div class="text-sm font-semibold text-orange-900 mb-2">ğŸ¬ å®Œç¾æ”¶å°¾</div>
                <p class="text-sm text-orange-800">${tips.closing}</p>
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }
    
    container.classList.remove('hidden');
}

// ===== åˆ·æ–°æ•°æ® =====
function refreshData() {
    loadData();
    loadExistingAnalysis();
}

// ===== å¯¼å‡ºæ•°æ® =====
async function exportData() {
    window.location.href = `${CONFIG.API_BASE_URL}/api/export/${CONFIG.SESSION_ID}`;
}

// ===== å¯¼å‡ºAIåˆ†ææŠ¥å‘Š =====
function exportAnalysis() {
    if (!analysisData) {
        alert('æš‚æ— AIåˆ†ææ•°æ®');
        return;
    }
    
    const text = JSON.stringify(analysisData, null, 2);
    const blob = new Blob([text], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `AIåˆ†ææŠ¥å‘Š_${CONFIG.SESSION_ID}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

// ===== å…³é—­åœºæ¬¡ =====
function closeSession() {
    if (!confirm('ç¡®å®šè¦å…³é—­å½“å‰åœºæ¬¡å—ï¼Ÿè¿™å°†åœæ­¢æ¥æ”¶æ–°çš„é—®å·æäº¤ã€‚')) {
        return;
    }
    alert('åŠŸèƒ½å¼€å‘ä¸­...');
}

// ===== æ¸…ç©ºæ•°æ® =====
async function clearAllData() {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ¸…ç©ºæ•°æ®åå°†æ— æ³•æ¢å¤ï¼ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é—®å·æ•°æ®å—ï¼Ÿ')) {
        return;
    }
    
    if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/api/cleanup/${CONFIG.SESSION_ID}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('æ•°æ®å·²æ¸…ç©º');
            location.reload();
        } else {
            throw new Error('æ¸…ç©ºå¤±è´¥');
        }
    } catch (error) {
        alert('æ¸…ç©ºæ•°æ®å¤±è´¥: ' + error.message);
    }
}

// çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜å›¾è¡¨
window.addEventListener('resize', () => {
    Object.values(charts).forEach(chart => chart.resize());
});
</script>

</body>
</html>
